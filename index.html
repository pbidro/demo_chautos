<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chileautos — Informe Semestral</title>
  <meta name="description" content="Landing responsiva con estilo carsales, KPIs, preferencias, y hero 3D con partículas." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Paleta corporativa (sin degradados) */
      --brand:#007CC2;            /* azul botón y títulos */
      --brand-600:#005EA8;        /* hover */
      --brand-soft:#E6F6FD;       /* suave */
      --ink:#0F172A;              /* texto principal */
      --sub:#475569;              /* texto secundario */
      --surface:#FFFFFF;          /* fondo */
      --surface-alt:#F7FAFC;      /* panel suave */
      --outline:#DFE7EF;          /* bordes */
      --shadow-1:0 1px 2px rgba(15, 23, 42, .06),0 1px 3px rgba(15, 23, 42, .08);
      --shadow-2:0 8px 24px rgba(15, 23, 42, .08),0 4px 12px rgba(15, 23, 42, .06);
      --radius:18px; --radius-sm:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--ink); background:var(--surface); overflow-x:hidden; font-family:'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin-inline:auto; padding:0 20px}

    /* App bar (sobre el hero 3D) */
    .appbar{position:fixed; inset:0 0 auto 0; z-index:50; background:rgba(255,255,255,.06); backdrop-filter:saturate(160%) blur(8px); border-bottom:1px solid rgba(223,231,239,.6)}
    .nav{height:72px; display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:12px}
    .brand-mark{width:40px; height:40px; border-radius:12px; background:var(--brand)}
    .brand strong{font-weight:800; letter-spacing:.2px}
    .nav-actions{display:flex; align-items:center; gap:10px}

    .btn{display:inline-flex; align-items:center; gap:.7rem; padding:.85rem 1.15rem; border-radius:999px; border:1px solid var(--outline); background:var(--surface); color:var(--ink); cursor:pointer; font-weight:800; box-shadow:var(--shadow-1)}
    .btn-primary{background:var(--brand); border-color:var(--brand); color:#fff}
    .btn-primary:hover{background:var(--brand-600); border-color:var(--brand-600)}

    .chip{display:inline-flex; align-items:center; gap:.45rem; padding:.45rem .8rem; border-radius:999px; border:1px solid var(--outline); background:var(--surface-alt); color:#334155; font-weight:800; font-size:.9rem}

    .section{padding:56px 0}
    .section > .container{background:var(--surface); border:1px solid var(--outline); border-radius:22px; box-shadow:var(--shadow-2); padding:28px 24px}

    /* Títulos de sección: icono circular + texto del mismo color */
    .sec-title{display:flex; align-items:center; gap:12px; margin:0 0 8px}
    .sec-title .sec-ico{width:46px; height:46px; border-radius:50%; background:var(--brand); color:#fff; display:inline-flex; align-items:center; justify-content:center; font-size:1.2rem; box-shadow:var(--shadow-1)}
    .sec-title .txt{font-weight:900; color:var(--brand); font-size:clamp(1.6rem,2.2vw,2rem)}

    .grid{display:grid; gap:20px}
    .card{background:var(--surface); border:1px solid var(--outline); border-radius:var(--radius); box-shadow:var(--shadow-1)}
    .card.pad{padding:20px}

    /* ===== HERO 3D de altura completa ===== */
    .hero3d{position:relative; height:100vh; overflow:hidden; background:var(--surface)}
    .hero3d-canvas{position:absolute; inset:0; z-index:1; display:block}
    .hero3d-overlay{position:relative; z-index:2; display:flex; align-items:center; justify-content:center; height:100%; text-align:center;}
    .hero3d-inner{width:100%; max-width:980px; margin:0 auto; padding:96px 0 64px; display:flex; flex-direction:column; align-items:center}
    .headline{margin:0; text-align:center; line-height:1.05}
    .headline .line-1{display:block; font-size:clamp(3.2rem, 8vw, 6rem); font-weight:900; color:var(--brand)}
    .headline .line-2{display:block; font-size:clamp(1.4rem, 3vw, 2.6rem); font-weight:800; color:var(--brand); margin-top:6px}
    .cta-row{display:flex; gap:12px; flex-wrap:wrap; margin-top:22px}
    #btn-scroll{font-size:clamp(1.25rem, 3vw, 2rem); padding:1.1rem 1.8rem}

    /* KPI cards compactas */
    #kpis.section{padding:28px 0}
    #kpis > .container{padding:18px 20px}
    .kpis{grid-template-columns:repeat(2,1fr)}
    .kpi{display:flex; align-items:center; gap:18px}
    .kpi .icon{font-size:clamp(2.6rem, 3vw, 3.4rem); line-height:1}
    .kpi .meta{color:#334155; font-size:1rem; font-weight:800}
    .kpi .value{font-size:clamp(1.8rem, 3vw, 2.6rem); font-weight:900; color:var(--ink)}

    /* Fuel preference grid */
    .fuel-grid{grid-template-columns:repeat(2,1fr)}
    .fuel-tile{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; border-radius:var(--radius-sm); padding:24px; border:1px solid var(--outline); box-shadow:var(--shadow-1); background:var(--surface)}
    .fuel-icon{font-size:clamp(2.6rem, 1.5vw + 1.6rem, 3.2rem); line-height:1}
    .fuel-name{font-weight:900; color:var(--brand)}
    .fuel-pct{color:#0f172a; font-weight:800; font-size:1.1rem}

    /* USUARIOS (mismo contenedor que otras secciones) */
    #usuarios.section{padding:28px 0}
    #usuarios > .container{padding:18px 20px}
    .users-chart{height:clamp(220px, 38vw, 320px)}

    /* Responsive */
    @media (min-width:640px){
      .kpis{grid-template-columns:repeat(2,1fr)}
      .fuel-grid{grid-template-columns:repeat(3,1fr)}
    }
    @media (min-width:992px){
      .kpis{grid-template-columns:repeat(3,1fr)}
    }
      /* ===== Demanda por región ===== */
    .region-grid{display:grid; gap:20px; grid-template-columns:1fr}
    
    .panel-title{display:flex; align-items:center; gap:.6rem; font-weight:800; margin:0 0 12px}
    .region-table{width:100%; border-collapse:separate; border-spacing:0 10px}
    .region-row{display:grid; grid-template-columns:1.2fr .3fr 1fr; align-items:center; gap:12px}
    .region-name{font-weight:800}
    .region-pct{font-weight:900; text-align:right}
    .bar{height:10px; border-radius:999px; background:var(--surface-alt); overflow:hidden; border:1px solid var(--outline)}
    .bar-fill{height:100%; background:var(--brand); border-radius:999px}

    /* Mapa estilizado */
    :root{ --norte:#3B82F6; --centro:#22C55E; --sur:#F97316; }
    .spine-wrap{position:relative; height:760px; padding:16px 96px 60px; background:linear-gradient(180deg, rgba(0,124,194,.06), rgba(0,124,194,.02)); border-radius:18px; border:1px solid var(--outline); overflow:hidden}
    .spine-wrap svg{position:absolute; inset:12px 96px 36px; width:calc(100% - 192px); height:calc(100% - 48px)}
    .chip-pin{position:absolute; left:50%; transform:translateX(-50%); width:34px; height:34px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:900; color:#fff; box-shadow:var(--shadow-1); border:2px solid #fff}
    .chip-norte{background:var(--norte)}
    .chip-centro{background:var(--centro)}
    .chip-sur{background:var(--sur)}

    /* Costillas laterales + etiquetas */
    .rib{position:absolute; height:2px; background:var(--outline); border-radius:2px; transform-origin:left center; --gap:26px;}
    .rib .rib-fill{position:absolute; inset:0; background:var(--rib-color, var(--brand)); opacity:.55; border-radius:inherit}
    .rib .nub{position:absolute; top:50%; width:12px; height:12px; border-radius:999px; background:var(--brand); transform:translateY(-50%); box-shadow:0 0 0 3px #fff, var(--shadow-1); z-index:1}
    .rib.right .nub{right:-6px; background:var(--rib-color, var(--brand))}
    .rib.left .nub{left:-6px; background:var(--rib-color, var(--brand))}
    .rib.right{--ang:14deg; left:calc(50% + var(--gap)); transform:rotate(var(--ang)); z-index:1}
    .rib.left{--ang:-14deg; left:calc(50% - var(--gap) - var(--w)); transform:rotate(var(--ang)); z-index:1}
    .rib .rib-label{position:absolute; top:50%; transform:translateY(-50%) rotate(calc(-1*var(--ang))); background:var(--surface); color:var(--ink); border:1px solid var(--outline); border-radius:999px; padding:.42rem .8rem; font-weight:900; font-size:1.25rem; box-shadow:var(--shadow-1); white-space:nowrap; z-index:2}
    .rib.right .rib-label{ right:-18px; }
    .rib.left .rib-label{ left:-18px; right:auto }

    /* Conector desde el pin al inicio de la costilla */
    .stem{position:absolute; height:2px; background:var(--rib-color, var(--brand)); border-radius:2px; z-index:1; transform-origin:left center}
    .stem.right{transform:none}
    .stem.left{transform:none}

    .zone-legend{display:flex; flex-direction:column; gap:8px; margin-top:14px; font-size:.95rem}
    .zone-item{display:flex; align-items:flex-start; gap:10px}
    .dot{width:12px; height:12px; border-radius:999px; margin-top:5px}

      /* ===== Secciones finales (Resumen / Sobre / Gracias) ===== */
    .section-heading{font-weight:900; text-align:center; color:var(--brand); font-size:clamp(1.8rem,3.2vw,2.4rem); margin:4px 0 18px}
    .section-sub{max-width:920px; margin:0 auto 20px; text-align:center; color:var(--sub); font-size:clamp(1rem,1.1vw+0.8rem,1.15rem)}

    .summary-grid{display:grid; gap:16px}
    @media(min-width:800px){.summary-grid{grid-template-columns:1fr 1fr}}
    .info-card{display:flex; gap:14px; align-items:flex-start; padding:16px 18px; border:1px solid var(--outline); border-radius:16px; background:var(--surface); box-shadow:var(--shadow-1)}
    .info-card .ico{flex:0 0 40px; height:40px; width:40px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background:var(--brand-soft); color:var(--brand); font-size:1.25rem; box-shadow:var(--shadow-1)}
    .info-card .txt strong{font-weight:900}

    .about-list{display:grid; gap:14px; max-width:980px; margin:0 auto}
    .about-item{display:flex; gap:12px; align-items:flex-start; padding:14px 16px; border:1px dashed var(--outline); border-radius:14px; background:var(--surface)}
    .about-item .ico{width:34px; height:34px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background:var(--brand-soft); color:var(--brand); font-weight:900}

    .final-cta .card{border-radius:20px; padding:28px 24px; text-align:center}
    .brand-lockup{display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:8px}
    .logo-dot{width:44px; height:44px; border-radius:12px; background:var(--brand); box-shadow:var(--shadow-1)}
    .brand-title{font-weight:900; font-size:clamp(1.6rem,3vw,2rem); color:var(--brand)}
    .headline-xl{font-weight:900; font-size:clamp(1.8rem,3.6vw,2.6rem); margin:6px 0 6px}
    .muted{color:var(--sub)}
    .pill-btn{display:inline-flex; align-items:center; gap:.6rem; background:var(--brand); color:#fff; border:1px solid var(--brand); border-radius:999px; padding:.9rem 1.2rem; font-weight:900; box-shadow:var(--shadow-1)}
    .pill-btn:hover{background:var(--brand-600); border-color:var(--brand-600)}
  </style>
</head>
<body>
  <!-- App bar -->
  <header class="appbar">
    <div class="container nav">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <strong>Chileautos · Reporte S1</strong>
        <span class="chip">Beta</span>
      </div>
      <div class="nav-actions">
        <button class="btn btn-primary" id="btn-print">Descargar PDF</button>
      </div>
    </div>
  </header>

  <!-- HERO 3D: ocupa toda la ventana -->
  <section class="hero3d" id="hero3d">
    <canvas id="stage3d" class="hero3d-canvas" aria-hidden="true"></canvas>
    <div class="hero3d-overlay">
      <div class="container hero3d-inner">
        <h1 class="headline"><span class="line-1">Informe Automotriz ChileAutos</span><span class="line-2">1er Semestre 2025</span></h1>
        <div class="cta-row"><button class="btn btn-primary" id="btn-scroll">Desliza ↓</button></div>
      </div>
    </div>
  </section>

  <!-- Introducción (texto contextual, sin cifras explícitas) -->
  <section class="section" id="intro">
    <div class="container intro-wrap">
      <div class="sec-title" style="margin-bottom:14px"><span class="sec-ico">🧭</span><span class="txt" style="font-size:clamp(1.8rem,3vw,2.4rem)">Introducción</span></div>
      <div class="intro-lead" style="font-size:clamp(1.06rem,1.1vw+1rem,1.28rem); line-height:1.9; letter-spacing:.1px">
        <p style="margin:.4rem 0 1rem">Este informe existe para <strong>alinear equipos</strong>, <strong>priorizar el roadmap</strong> y <strong>medir impacto</strong> con una lectura simple del semestre. Más que una planilla, es un <em>relato de negocio</em> sobre cómo se movió la demanda, cómo respondió la oferta y dónde surgen oportunidades.</p>
        <p style="margin:0 0 1rem">La narrativa <strong>evita tecnicismos</strong> y se enfoca en señales accionables: estacionalidad, concentración geográfica, atracción de usuarios y generación de interés. Las cifras viven en las secciones; aquí nos quedamos con el <em>para qué</em>: tomar mejores decisiones en producto, marketing y comercial.</p>
        <div class="intro-note" style="background:var(--brand-soft); border:1px solid var(--outline); border-left:6px solid var(--brand); padding:16px 18px; border-radius:16px; color:#0f172a; margin-top:.5rem">
          <strong>Cómo leerlo.</strong> En cada módulo pregúntate: <em>¿qué cambió?</em>, <em>¿dónde ocurrió?</em> y <em>¿qué haríamos distinto?</em> Esa es la brújula del reporte.
        </div>
      </div>
    </div>
  </section>

  <!-- KPIs principales (antes de Usuarios) -->
  <section class="section" id="kpis">
    <div class="container">
      <div class="sec-title"><span class="sec-ico">📊</span><span class="txt">KPIs Clave (S1)</span></div>
      <p class="sub">Cifras aproximadas (+) y placeholders <strong>TBD</strong> donde no hay dato aún.</p>
      <div class="grid kpis">
        <div class="card pad"><div class="kpi"><span class="icon">🚗</span><div><div class="meta">Vehículos totales</div><div class="value">160.000+</div></div></div></div>
        <div class="card pad"><div class="kpi"><span class="icon">📦</span><div><div class="meta">Vehículos disponibles</div><div class="value">47k+</div></div></div></div>
        <div class="card pad"><div class="kpi"><span class="icon">📨</span><div><div class="meta">Leads totales</div><div class="value">977k+</div></div></div></div>
        <div class="card pad"><div class="kpi"><span class="icon">💸</span><div><div class="meta">Precio promedio interesados</div><div class="value">15M+</div></div></div></div>
        <div class="card pad"><div class="kpi"><span class="icon">👥</span><div><div class="meta">Usuarios activos (únicos)</div><div class="value">TBD</div></div></div></div>
        <div class="card pad"><div class="kpi"><span class="icon">🌐</span><div><div class="meta">Visitas totales S1</div><div class="value">TBD</div></div></div></div>
      </div>
    </div>
  </section>

  <!-- Usuarios únicos por mes (mismo contenedor que el resto) -->
  <section class="section" id="usuarios">
    <div class="container">
      <div class="sec-title"><span class="sec-ico">👥</span><span class="txt">Usuarios únicos por mes · S1 2025</span></div>
      <div class="sub" style="margin-top:8px">Total semestre: <strong id="usersTotal">—</strong></div>
      <div class="card pad" style="margin-top:16px">
        <canvas id="usersChart" class="users-chart"></canvas>
      </div>
    </div>
  </section>

  <!-- Preferencias por combustible -->
  <section class="section" id="combustible">
    <div class="container">
      <div class="sec-title"><span class="sec-ico">⛽</span><span class="txt">Preferencias por tipo de combustible</span></div>
      <p class="sub">Distribución de interés en búsquedas/cotizaciones por motorización.</p>
      <div class="grid fuel-grid" aria-label="Preferencias combustible">
        <div class="fuel-tile"><div class="fuel-icon">⛽</div><div class="fuel-name">Bencina</div><div class="fuel-pct">77%</div></div>
        <div class="fuel-tile"><div class="fuel-icon">🛢️</div><div class="fuel-name">Diésel</div><div class="fuel-pct">21%</div></div>
        <div class="fuel-tile"><div class="fuel-icon">🔋</div><div class="fuel-name">Híbrido</div><div class="fuel-pct">1%</div></div>
        <div class="fuel-tile"><div class="fuel-icon">⚡</div><div class="fuel-name">Eléctrico</div><div class="fuel-pct">0.3%</div></div>
        <div class="fuel-tile"><div class="fuel-icon">🔥</div><div class="fuel-name">Gas</div><div class="fuel-pct">0.1%</div></div>
        <div class="fuel-tile"><div class="fuel-icon">🚘</div><div class="fuel-name">Otros</div><div class="fuel-pct">0.7%</div></div>
      </div>
    </div>
  </section>

  <!-- Demanda por región -->
  <section class="section" id="regiones">
    <div class="container">
      <div class="sec-title"><span class="sec-ico">🗺️</span><span class="txt">Demanda en las regiones de Chile</span></div>
      <div class="spine-wrap" id="spineMap" aria-label="Mapa estilizado de Chile"></div>
      <div class="zone-legend">
        <div class="zone-item"><span class="dot" style="background:var(--norte)"></span>
          <div><strong>Zona Norte</strong> — Arica y Parinacota, Tarapacá, Antofagasta, Atacama, Coquimbo. <em id="pctNorte"></em></div>
        </div>
        <div class="zone-item"><span class="dot" style="background:var(--centro)"></span>
          <div><strong>Zona Centro</strong> — Valparaíso, Metropolitana, O'Higgins, Maule. <em id="pctCentro"></em></div>
        </div>
        <div class="zone-item"><span class="dot" style="background:var(--sur)"></span>
          <div><strong>Zona Sur</strong> — Ñuble, Biobío, La Araucanía, Los Ríos, Los Lagos, Aysén, Magallanes. <em id="pctSur"></em></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Resumen del sector (Chileautos) ===== -->
  <section class="section" id="resumen">
    <div class="container">
      <h2 class="section-heading">Resumen del semestre</h2>
      <p class="section-sub">Principales señales para tomar decisiones en producto, marketing y comercial. Cifras redondeadas.</p>
      <div class="summary-grid">
        <div class="info-card"><span class="ico">📈</span><div class="txt"><strong>Concentración geográfica:</strong> la <strong>RM</strong> aporta el <strong>57.5%</strong> de la demanda; <strong>Valparaíso</strong> un <strong>8.7%</strong>.</div></div>
        <div class="info-card"><span class="ico">🚘</span><div class="txt"><strong>Inventario:</strong> universo de <strong>160k+ vehículos</strong> con <strong>47k+</strong> disponibles promedio.</div></div>
        <div class="info-card"><span class="ico">🧲</span><div class="txt"><strong>Generación de interés:</strong> más de <strong>977k</strong> leads en el semestre.</div></div>
        <div class="info-card"><span class="ico">⛽</span><div class="txt"><strong>Motorización preferida:</strong> Bencina <strong>77%</strong>, Diésel <strong>21%</strong>; Híbrido <strong>1%</strong>, Eléctrico <strong>0.3%</strong>.</div></div>
      </div>
    </div>
  </section>

  <!-- ===== Sobre el informe ===== -->
  <section class="section" id="sobre">
    <div class="container">
      <h2 class="section-heading">Sobre este informe</h2>
      <div class="about-list">
        <div class="about-item"><span class="ico">ℹ️</span><div><strong>Uso recomendado.</strong> Este documento resume tendencias semestrales para alinear equipos y priorizar el roadmap. No sustituye reportes financieros ni auditorías.</div></div>
        <div class="about-item"><span class="ico">🔄</span><div><strong>Comparabilidad.</strong> Mantiene criterios consistentes con semestres previos para comparar estacionalidad y concentración territorial.</div></div>
        <div class="about-item"><span class="ico">✉️</span><div><strong>Contacto.</strong> ¿Dudas o sugerencias? Escríbenos a <a href="#" class="txt">analytics@chileautos.cl</a>.</div></div>
      </div>
    </div>
  </section>

  <!-- ===== Cierre / Gracias ===== -->
  <section class="section final-cta" id="gracias">
    <div class="container card">
      <div class="brand-lockup">
        <span class="logo-dot" aria-hidden="true"></span>
        <div class="brand-title">Chileautos</div>
      </div>
      <div class="headline-xl">¡Gracias por revisar nuestro informe!</div>
      <p class="muted" style="margin:0 0 16px">Esperamos que esta radiografía del sector automotriz 2025 te haya sido útil.</p>
      <a class="pill-btn" href="https://www.chileautos.cl" target="_blank" rel="noopener noreferrer">Visitar Chileautos.cl</a>
    </div>
  </section>

  <footer class="section" style="border-top:1px solid var(--outline)">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between">
      <div class="sub">© 2025 Chileautos · Demo</div>
      <div style="display:flex; gap:12px"><a href="#" class="sub">Privacidad</a><a href="#" class="sub">Términos</a></div>
    </div>
  </footer>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

  <!-- Hero 3D: partículas + toros con rebote -->
  <script>
    const canvas = document.getElementById('stage3d');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
    if (renderer.outputColorSpace !== undefined) { renderer.outputColorSpace = THREE.SRGBColorSpace; } else { renderer.outputEncoding = THREE.sRGBEncoding; }
    renderer.setClearColor(0x000000, 0);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 200);
    camera.position.set(0, 1.2, 5.0);

    function resize(){
      const w = window.innerWidth, h = window.innerHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      renderer.setSize(w, h, true);
      camera.aspect = w/h; camera.updateProjectionMatrix();
    }
    resize();
    window.addEventListener('resize', resize);

    // Luces
    const hemi = new THREE.HemisphereLight(0xffffff, 0xE6F6FD, 0.9); hemi.position.set(0, 2, 0); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.2); dir.position.set(3, 5, 3); scene.add(dir);

    // Sprite circular para bokeh suave
    function makeBokehTexture(size=128){
      const c = document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d');
      const g = ctx.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2);
      g.addColorStop(0,'rgba(255,255,255,1)');
      g.addColorStop(0.5,'rgba(255,255,255,0.4)');
      g.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(size/2,size/2,size/2,0,Math.PI*2); ctx.fill();
      const tex = new THREE.CanvasTexture(c);
      if (tex.colorSpace !== undefined) tex.colorSpace = THREE.SRGBColorSpace; else tex.encoding = THREE.sRGBEncoding;
      tex.needsUpdate = true; return tex;
    }
    const sprite = makeBokehTexture();

    // Partículas (dos capas) con bokeh redondeado, banda más alta y separada
    function makeParticles(count, size, color, spread=34){
      const positions = new Float32Array(count * 3);
      for (let i=0; i<count; i++){
        positions[i*3+0] = (Math.random()-0.5) * spread;
        positions[i*3+1] = Math.random() * (spread*0.25) - (spread*0.05); // un poco por encima del centro
        positions[i*3+2] = (Math.random()-0.5) * spread;
      }
      const geo = new THREE.BufferGeometry(); geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const mat = new THREE.PointsMaterial({ color, size, map:sprite, alphaMap:sprite, sizeAttenuation:true, transparent:true, opacity:0.85, depthWrite:false, blending:THREE.AdditiveBlending });
      return new THREE.Points(geo, mat);
    }
    const layerA = makeParticles(1600, 0.12, 0x007CC2, 34);
    const layerB = makeParticles(1000, 0.18, 0x0059C9, 42);
    scene.add(layerA); scene.add(layerB);

    // Toros más arriba y muy separados, con rebote
    const floaters = new THREE.Group(); scene.add(floaters);
    const torusMat = new THREE.MeshStandardMaterial({ color:0x0059C9, metalness:0.2, roughness:0.4 });
    const TORUS_COUNT = 8;
    const bounds = { x:7.5, y:1.6, z:5.5 }; // límites de rebote
    const vel = [];
    for(let i=0;i<TORUS_COUNT;i++){
      const torus = new THREE.Mesh(new THREE.TorusGeometry(0.32, 0.09, 16, 64), torusMat);
      torus.position.set((Math.random()-0.5)*14.0, Math.random()*1.5+0.3, (Math.random()-0.5)*11.0);
      torus.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
      floaters.add(torus);
      vel.push(new THREE.Vector3((Math.random()*0.8-0.4), (Math.random()*0.5-0.25), (Math.random()*0.8-0.4)));
    }

    // Interacción scroll/mouse
    let scrollY = 0, mouseX=0, mouseY=0; const lerp = (a,b,t)=>a+(b-a)*t;
    window.addEventListener('scroll', ()=>{ scrollY = window.scrollY || document.documentElement.scrollTop; });
    window.addEventListener('mousemove', (e)=>{ const nx=(e.clientX/window.innerWidth)*2-1, ny=(e.clientY/window.innerHeight)*2-1; mouseX=nx; mouseY=ny; });

    const clock = new THREE.Clock();
    function animate(){
      const t = clock.getElapsedTime(); const dt = Math.min(clock.getDelta(), 0.033);
      // Partículas: deriva
      layerA.rotation.y = t*0.02; layerA.position.y = Math.sin(t*0.6)*0.05;
      layerB.rotation.y = -t*0.015; layerB.position.y = Math.cos(t*0.5)*0.05;

      // Toros: movimiento + rebote
      floaters.children.forEach((m, i)=>{
        m.rotation.x += 0.004 + i*0.0003;
        m.rotation.y += 0.005 + i*0.0002;
        m.position.addScaledVector(vel[i], dt);
        if (m.position.x > bounds.x || m.position.x < -bounds.x){ vel[i].x *= -1; m.position.x = THREE.MathUtils.clamp(m.position.x, -bounds.x, bounds.x); }
        if (m.position.y > bounds.y || m.position.y < -bounds.y){ vel[i].y *= -1; m.position.y = THREE.MathUtils.clamp(m.position.y, -bounds.y, bounds.y); }
        if (m.position.z > bounds.z || m.position.z < -bounds.z){ vel[i].z *= -1; m.position.z = THREE.MathUtils.clamp(m.position.z, -bounds.z, bounds.z); }
      });

      // Parallax suave
      const progress = Math.min(scrollY / (window.innerHeight*1.2), 1);
      camera.position.z = lerp(5.0, 3.6, progress);
      camera.position.y = lerp(1.2, 1.0, progress);
      floaters.rotation.x = lerp(floaters.rotation.x, mouseY*0.15, 0.08);
      floaters.rotation.y = lerp(floaters.rotation.y, mouseX*0.2, 0.08);

      renderer.render(scene, camera); requestAnimationFrame(animate);
    }
    animate();
  </script>

  <!-- Interacciones generales: Descargar PDF, Scroll del hero, Ocultar navbar al salir del hero -->
  <script>
    // Descargar como PDF (usa diálogo del navegador)
    const printBtn = document.getElementById('btn-print');
    if (printBtn) printBtn.addEventListener('click', () => window.print());

    // Scroll suave de "Desliza ↓" hacia la Intro
    const scrollBtn = document.getElementById('btn-scroll');
    if (scrollBtn) scrollBtn.addEventListener('click', ()=>{
      const target=document.querySelector('#intro');
      if(target){ target.scrollIntoView({behavior:'smooth'}); }
    });

    // Ocultar appbar cuando el hero ya no está visible
    const hero = document.getElementById('hero3d');
    const appbar = document.querySelector('.appbar');
    if (hero && appbar){
      const io = new IntersectionObserver(([e]) => {
        appbar.style.display = e.isIntersecting ? 'block' : 'none';
      }, {threshold:0.05});
      io.observe(hero);
    }
  </script>

  <!-- Chart de Usuarios -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const labels=['Ene','Feb','Mar','Abr','May','Jun'];
      const data=[2057505,1889500,2230320,2100378,2260183,2021683];
      const total=data.reduce((a,b)=>a+b,0);
      function fmtMillions(n){ return (n/1e6).toFixed(1)+'M+'; }
      const totalEl=document.getElementById('usersTotal'); if(totalEl) totalEl.textContent = fmtMillions(total);
      const el=document.getElementById('usersChart'); if(!el) return;
      const ctx=el.getContext('2d');
      const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#007CC2';
      new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[{ label:'Usuarios únicos', data, borderColor:brand, backgroundColor:'transparent', fill:false, borderWidth:5, tension:.35, pointRadius:5, pointBackgroundColor:brand, pointBorderColor:'#fff', pointBorderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, layout:{padding:24}, plugins:{ legend:{display:false}, tooltip:{ mode:'index', intersect:false }}, scales:{ x:{ grid:{display:false}}, y:{ grid:{display:false}} }}
      });
    })();
  </script>
  
  <!-- Script: construir sección Demanda por región -->
  <script>
    (function(){
      const REGIONS = [
        {name:'Región Metropolitana', code:'CL-RM', label:'RM', zone:'centro', count:1300233},
        {name:'Biobío', code:'CL-BI', label:'VIII', zone:'sur', count:199930},
        {name:'Valparaíso', code:'CL-VS', label:'V', zone:'centro', count:196280},
        {name:'La Araucanía', code:'CL-AR', label:'IX', zone:'sur', count:150788},
        {name:'Antofagasta', code:'CL-AN', label:'II', zone:'norte', count:142034},
        {name:'Los Lagos', code:'CL-LL', label:'X', zone:'sur', count:57526},
        {name:'Maule', code:'CL-ML', label:'VII', zone:'centro', count:49747},
        {name:"O'Higgins", code:'CL-LI', label:'VI', zone:'centro', count:49515},
        {name:'Coquimbo', code:'CL-CO', label:'IV', zone:'norte', count:35145},
        {name:'Ñuble', code:'CL-NB', label:'XVI', zone:'sur', count:21399},
        {name:'Los Ríos', code:'CL-LR', label:'XIV', zone:'sur', count:15970},
        {name:'Atacama', code:'CL-AT', label:'III', zone:'norte', count:12760},
        {name:'Tarapacá', code:'CL-TA', label:'I', zone:'norte', count:12210},
        {name:'Magallanes y Antártica', code:'CL-MA', label:'XII', zone:'sur', count:8012},
        {name:'Arica y Parinacota', code:'CL-AP', label:'XV', zone:'norte', count:6199},
        {name:'Aysén', code:'CL-AI', label:'XI', zone:'sur', count:3756}
      ];

      // Totales y helper
      const total = REGIONS.reduce((s,r)=>s+r.count,0);
      const pctNum = (n)=> (n/total)*100; const pctStr = (n)=> pctNum(n).toFixed(1);

      // Contenedor del mapa
      const spine = document.getElementById('spineMap');
      if(!spine) return;

      // SVG "columna vertebral"
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('viewBox','0 0 200 740');
      svg.innerHTML = `
        <defs>
          <linearGradient id="spineGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#C7E6F6"/>
            <stop offset="100%" stop-color="#DFF2FB"/>
          </linearGradient>
        </defs>
        <path d="M100 20 C 120 130, 80 240, 100 350 S 80 560, 100 700 S 120 720, 100 720" fill="none" stroke="url(#spineGrad)" stroke-width="16" stroke-linecap="round"/>
        <path d="M100 20 C 120 130, 80 240, 100 350 S 80 560, 100 700 S 120 720, 100 720" fill="none" stroke="#90D2EE" stroke-width="4" stroke-linecap="round" stroke-dasharray="6 8"/>
      `;
      spine.appendChild(svg);

      // Coordenadas Y (de norte a sur) y pines
      // FIX: declarar primero el orden; así evitamos ReferenceError
      const orderTopToBottom = ['CL-AP','CL-TA','CL-AN','CL-AT','CL-CO','CL-VS','CL-RM','CL-LI','CL-ML','CL-NB','CL-BI','CL-AR','CL-LR','CL-LL','CL-AI','CL-MA'];
      const Y = {}; const start=40, step=44; orderTopToBottom.forEach((code,i)=>{ Y[code] = start + i*step; });

      // Pines centrales por región
      REGIONS.forEach(r=>{
        const pin = document.createElement('div');
        pin.className = `chip-pin chip-${r.zone}`;
        pin.style.top = (Y[r.code]||0) + 'px';
        pin.textContent = r.label;
        pin.title = `${r.name} · ${pctStr(r.count)}%`;
        spine.appendChild(pin);
      });

      // Modelo basado en IDs: {id, y, value, color}
      const pinRadius = 17;               // ~34px de diámetro / 2
      const offsetFromCircle = 8;         // sale desde el borde del pin + 8px
      const elbowHoriz = offsetFromCircle; // tramo horizontal del codo
      const ribLen = 120;                 // tramo diagonal base
      const minGap = 16;                  // separación mínima entre etiquetas del mismo lado

      const points = orderTopToBottom.map((code, idx)=>{
        const r = REGIONS.find(x=>x.code===code);
        const value = parseFloat(pctNum(r.count).toFixed(1));
        const color = r.zone==='norte' ? 'var(--norte)' : (r.zone==='centro' ? 'var(--centro)' : 'var(--sur)');
        return { id:code, y:Y[code]+17, value, color, side: (idx%2===0 ? 'left' : 'right') };
      });

      // Resolver colisiones verticales sin alterar Y del pin (ajustamos solo la etiqueta)
      let lastLeft=-Infinity, lastRight=-Infinity;
      points.forEach(p=>{
        let ly = p.y; const last = (p.side==='left')?lastLeft:lastRight;
        if (isFinite(last) && ly - last < minGap) ly = last + minGap;
        p.labelY = ly;
        if (p.side==='left') lastLeft = ly; else lastRight = ly;
      });

      // Auto-ajustar alto del contenedor si hace falta
      const maxLabelY = Math.max(...points.map(p=>p.labelY));
      const desiredHeight = Math.max(spine.clientHeight, maxLabelY + 80);
      spine.style.height = desiredHeight + 'px';

      // Dibujar conectores (codo: horizontal + diagonal) y etiquetas
      points.forEach(p=>{
        // --- tramo horizontal (no atraviesa el pin) ---
        const stem = document.createElement('div');
        stem.className = `stem ${p.side}`;
        stem.style.top = p.y + 'px';
        stem.style.height = '2px';
        stem.style.width = elbowHoriz + 'px';
        stem.style.left = p.side==='right'
          ? `calc(50% + ${pinRadius}px)`
          : `calc(50% - ${pinRadius}px - ${elbowHoriz}px)`;
        stem.style.setProperty('--rib-color', p.color);
        spine.appendChild(stem);

        // --- tramo diagonal (anchura fija, ángulo calculado hacia labelY) ---
        const dy = p.labelY - p.y;
        const ang = Math.atan2(dy, ribLen) * 180 / Math.PI; // grados
        const rib = document.createElement('div');
        rib.className = `rib ${p.side}`;
        rib.style.setProperty('--ang', `${p.side==='right'? ang : -ang}deg`);
        rib.style.width = ribLen + 'px';
        rib.style.top = p.y + 'px';
        rib.style.left = p.side==='right'
          ? `calc(50% + ${pinRadius + elbowHoriz}px)`
          : `calc(50% - ${pinRadius + elbowHoriz}px - ${ribLen}px)`;
        rib.style.setProperty('--rib-color', p.color);
        rib.innerHTML = `<div class="rib-fill"></div><span class="nub"></span><span class="rib-label">${p.value.toFixed(1)}%</span>`;
        spine.appendChild(rib);
      });

      // Porcentajes por zona en la leyenda
      const z = {norte:0, centro:0, sur:0};
      REGIONS.forEach(r=>{ z[r.zone]+=r.count; });
      const pN = document.getElementById('pctNorte'); if(pN) pN.textContent = `(${pctStr(z.norte)}%)`;
      const pC = document.getElementById('pctCentro'); if(pC) pC.textContent = `(${pctStr(z.centro)}%)`;
      const pS = document.getElementById('pctSur');   if(pS) pS.textContent = `(${pctStr(z.sur)}%)`;
    })();
  </script>
</body>
</html>
